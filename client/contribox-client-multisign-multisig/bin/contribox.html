<!doctype html>
<html lang="en-us">

<head>
  <meta charset="utf-8">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <title>Wallycore shell</title>
  <style>
    textarea {
      font-family: monospace;
      width: 80%;
      padding-right: 0;
      margin-left: auto;
      margin-right: auto;
      display: block;
    }
  </style>
</head>

<body>
  <textarea id="output" rows="8"></textarea>
  <script async type="text/javascript" src="contribox.js"></script>
  <script async type='text/javascript' src='main.js'></script>
  <script defer type='text/javascript'>
    function main() {
      if (init() !== 0) {
        alert("initialization failed");
        return;
      };
      console.log("Libwally successfully initialized\n");
      var wallet = newWallet();
      if (wallet === "") {
        alert("Wallet creation failed");
        return;
      }

      otherMnemonic = "bag buffalo scrap bamboo crane release history bullet screen junior type camp creek flip boy cabbage opera dizzy layer army useless domain fall mirror";
      restored = JSON.parse(restoreWallet(otherMnemonic));
      if (restored.xpub.localeCompare("xpub661MyMwAqRbcGqusUEqrpdR5YiQHQnaBbyrW2pWNJAUrQK6ZNDwrMyUFNsmR3WtzGgUwwHAX5P8ymmQDgLDKHcWThLVunQXWmvskKEoKp5U") === 0) {
        console.log("restored wallet is OK ");
      }

      console.log("first derived pubkey is " + restored.pubkey0);

      // try to create a confidential address out of a script
      // var script = "5121036f611d04b32a28d8765350f94b9ee519b5607c35a293363148713a971809cf9b21036275723cc7f370ebde1c573bf68900f01a204a4709473d6ae3e110095b081e9b2103f638f867c78a083ef12efc8ee14d856e0bc0fdb094306f6e5744d865f193f93653ae64022c01b269685321032bd879a5803895e510b5159a0b13305c647036466f822db5c57e6efc41750a98210244d49967c7c2d0f002f5769e9eb8b1b6c06e094d9022ae8162596a2bc06b6c4c210299697af95482056fa7d56125ea1edc1c68c0eee7d5d847f13dd2344d79150e5453af5221035d2bfec06d1ffe2854fe2ef8cd9758ab58ddf7ee939efb3d6abb9634d541b62b21027782205e53634b893e4fe763060b92c27090609f77b7420329acfd8b4eca13c621020e0eee8a886c4d619e34d4b828406ecd37aa803bdc03b95e44335ecf3fd9bf2d53af532102ac400f4ed0b8f821af77ba4f6a115eeb6871226e94df6095610cda7daab5cdee2102e73e89a7bfbeb60aea35a21f499aae9a6570b1687d8e43bf016d3c379a20e5b72102c1448f93b8391c2e550690c5ae2a373435e3e42a13204bc2cdd51fa378209b2753af5221022e92129208f3ce38ffde337e63060ebdd8627d5a621f593620ab8d2c878ba4032102f6e9c339b9ece67a171329aa2c361e3d25e50a4ad4175fc8c7b259d131ff82d92103a11f6f6d9a73ed187009f92cac185daef62bedd995dc3f84e04c369aa6f783af53af53210230db9e97fd444bbde0b5b4607903553ae294dc2909c2dd972738519c0783dbeb2102fdff72bff95447786e64427b8948215e97915ba58004edc3d4806989418395a8210218a3eba6da1e00ab11d92a502d96fae41971c962bd06c49e8f63e309748e400a53af5121023c88c1920452850482955eabe3342eb1699e4bf095427ac68614c9ca620d6bdc210338585bd8711650d5479e4142dbac328627b02321edd2fcb0e289f88a3142a2372102a06c1c020dbff7515c7dfeda755a29840235c6e6339e8214d12093ea471f87f253ae64022c01b2696853210347e8e70b54af0f329050426cdffbac4f2ca518f023e692ef8a3acdac443309ad21037e1463261f116ea7378144c8ad25af0b1211532d6fa32712378bf16f2b44c5a121035f81c2880ea04ce75e3ba50492b7b1a41cf32e0797a5615249e3d16cf26f63e253af522103b16a14753140dfd863a887f7748f518570d0787164c15debd9f07842d72790012102c11de8d77df28c24c2751cf56acd989dc87858555e82912d02a2352a88740b5c2103567a6649e85b1ec66fb4155b305244533c06b1fe1e7309d4908a1111414435bc53af5321030c997fa17f018e85e04db0ea2690da5c09a295da3e4c4522b366a3d7113e50e92102c6fa89cfe2b2eac1cc303c0de2dabc6b89ad290fdf72ffc4eef51b1c4ae24bb7210397c22c5634e5dae8a273b5ed93327a150a159a7058b6b72deb8871218f63299f53af51210238a257943c66e36a867ed337e9523f82131e550809a2835ea4ed7ce9ef04668b2102b83ebc4982f523b840e557b1b1c3c13589b6e0b3262e138e1bf0212727b0160b210346523c185ede552e52865408003ced2718f332ed8af65fef8b82b45225a2bf4a53ae64022c01b2696851210228b1422c02b60152602eecbacff7eb32a5e642cef30213e99b8acf3b1b7501d421024f38f9acae6f24bf7f95a1e2e663d804bcd9a7f0bc3414f9107966af801c193321037bac05d72379a23a0f6a95fdbf22b069fe2965ee4c5ecdb37f1aa85cfc1266f153ae64022c01b26968532102b1e413bb57ba7699f065428b9769a2f8fd55522094b6e0ae8e9331f0c23f006621022d7fc47891dbb1b76417db40d084ede76e405f7dec21f7615bf3f6a2ad2d82dc2102c308de0c84f1cdd8ed5e6eb4e36968c1fa9a5b1d912c55b945f10524cf83a3ec53af5221026edfbdc92ab2b8c51c192a226a2ebb59085a36ea19ebac09b38dc5634ccee8012102257ec1cefe4ff5a45c98afd4a14e623538e8bf7676ab01ab760d39b2079bfb2f210243be3c9597e2607b289d04a269e8aaaec8ef74a698f1937bcbf961acb88e3ed453af532102289c3d92bb5788269c8f4748fe9cb987864855d5bf32de37c728e3f743af7dd921038776c2a17e6c3096493b5ab1df1ebced17acdb5200004bad34c622a4f9fe7c522102324a31538849cf909d2c37475aad61eed7abdecab374fa159d153688f304ea4953ae";
      // multisig = JSON.parse(newConfidentialAddressFromScript(script, restored, password));
      // console.log("private_blinding_key is " + multisig.privateBlindingKey);
      // console.log("address is " + multisig.unconfidentialAddress);
      // console.log("confidential address is " + multisig.confidentialAddress);

      // derive an address from the xpub
      var path = "0/0";
      mineAddress = JSON.parse(newAddressFromXprv(restored.xprv, path, restored.range));
      // console.log("address is " + mineAddress.unconfidentialAddress);
      // console.log("pubkey is " + mineAddress.pubkey)

      var path = "1/0";
      theirAddress = JSON.parse(newAddressFromXpub(restored.xpub, path, restored.range));
      // console.log("address is " + theirAddress.unconfidentialAddress);
      // console.log("pubkey is " + theirAddress.pubkey)

      // create a new tx that spend prevTx
      unblindedPrevTx = "020000000101d6c3b03c06d54af6622d48eb7ecd3fb6901b3e5247b12c2427002a2106c27fb60100000000fdffffff0301230f4f5d4b7c6fa845806ee4f67713459e1b69e8e60fcee2e4940c7a0d5de1b201000000000000271000160014d8aace49e4f3311d0f7a8bda5224caf043643f500a90a24d5faf7e67b8de36486bd351aac6639d72813273c4aeba55ec818c03f73309c462bfd628481a6af05459a4991eccee8d024511f2f3825d995226dca9969a09024d493cf2376c471ea43817c834898b5765deaa4a12f66192135e4b74d285d566160014e5eb6278249b257584ddb8dc6991d112395a53b901230f4f5d4b7c6fa845806ee4f67713459e1b69e8e60fcee2e4940c7a0d5de1b2010000000000000abc00000000000000000247304402203746a611779de70810cee1c462aacf7c25e0c37be8e798267f653a17cda799e302201d8f42b5c99e65eee50e62bd3c3408a344067a7b14c217d674414ab2797e99db012102b3a7bba251f5041725ae8607c8f739ee8eb12a27ec318484755c93f49ac229a9000000430100011a1b2ec64aa440276e9355f88fe69102ac9dbf29d298f6d795b7c513f76104952010d573e20fe91007cce07989c5e51213f77ae5e0d5c606db2c583482e42dedfd4e106033000000000000000141a239000451d1f96240efd31e02582c94136689d87856306cceed73e950e5c258ec690fc44d19476c3a4ed73b2ef1ff4e05dd3787a7b7aa0572f91c1b6a1202c8d9a3d72fa6e2976a3f61f241ef97fcb084297aafb3e78a954e4318872f4b7ee829946efea76da3fa3f1ec75a8bb235a19a34277f9453647a9d611403fb4299dee216aa6cca29fab3b8f71efa420ea13727764e7f258b0df9f8bba7ed353b867ef19f9997558089fd8e8edd36c399589e45a80afbd50d92d61a931bb3d932789bbfc9987b796a1769d469b97e5d88b9d80ba624b336fbd960f1ccd21c2d0249fd056115062251db2aeab29d0b03e1c47cdd7caca12ae98ccd031060dc8729bf20226e5d2063007ab44f7cfc7947db7b2b77bc9f4ff2db37891c8fc9b2912b4708f82ec309478ab46d60aa340909cd1b25294dfa22e59bc177d04e23dc3677338bcfa35f6bd4e10eeeb5f10be22d7fc4c5768843ab23c1a171f39732aea5efe352c012aa3ed9f599ecc469c4f106a2033c7ddb0e8692730b3281b0b63e40bc5fa1cc8ce3d251814e7cfb209eb96bc797b4db54a719e9b0905d39d349cb70a7e316792c2dbcaef8d590e6b78dd4a9bb15b06912c4b279c9e4e93aafbfa91e1172806c0fe44dd5bf52263b3eac6ed79e423904d9d203c29f16d43b6efdcf5bff5add2bd7f79eb221c7930e0314c79b49196b69e9da4163e97ba79902f1f30ab46579704e0e12f7f277c8d08a7949a36a6c9379cb90c59b33ab9ad6c582d62fa16b452a4294de9438b072e2b03d03e70ca4b388ff46c2a92442eaa1e5696754d93575bd639be441b2dd3027b05a9a3e72ef427e1fdd8eb51b7724ca5333fa91fe107022e2ceea02aa0dc126277172e410a76a73725b16e69a4d257d101d252ad1e7dc46387f02fa0a6886cb6ba1fe537f273cb98c6a4919e4c5bc9a1d36d8b0853b1f153921d758e10f7418f810c9f4081d087b86d7c435f37822df3b279e36c420b017dcdc812ce86f328e10a2dc72b7967ae82077f1ee49193a3dafcc225a757454a6183e9d5febb9378dfe5a696d3853ba26f2407fb0173ae1cdf807ba7942b9f1b84b1242bd75cedafa5a43bd0739d66b0b8e5ec205bc9547130db602f81e35949d2af4e06478ee39fa1c7fa5596c3608999c2253e1b31b22a026f457ea74f5c0c494c43c115ff9d6bc2d7a5e5e27490354ce178c25921cdb9b56974ee5cc85a3663e040e73311b08e71b9604d3b98b74858b9e579958ccdc40a30e74781abab013e689f57fa071949b7481d47ff1c26b0e335b45af928cb723743c867be5157409876058b00d58f36908369596c4d7b6ceb04b89088ecccb79e67a1b84f389ab8a9d19672e056a16b47365a0c518ee5d0378ce62c0a8f218837b78814fe4c0c6906e5063d1266aff1b0ccd000ec7016f71fbf211d573881be63c2b86e40c5b9a9e66ca22a0a86e43919ca0f6e3df51b64324b0a406ac1a046b39c59fa29ed3566d3d314181d6013aedb2d5ae0ef65f313cd42f9a493c72c180c25086cc80c7f53b6cd47042f5893ae4361e2f65113b187f602923e6d571365c3cd59c521dcae15bbfaf4f68ba2295fd650bc68ff1e5ea083178bd5e9f403c530b09818767c809aa1e76cce2d2c6e24ac2c1949fe8dbd4d0c31169c5e0d43695020c98941f707bf18758cb86903542de92a6fc9b2e43d97f4c8b969d80232befa025057aea78446521e31daf838556c3d7ce80367b094fb3cde7c8031eac4f922f28bd8db5b47dbddddf5a4e08f49104f079df5369566a299c1477d502e91cf7b3ff45d055d5283f66cf23274a7767bcc3432094134747d02876a2357afdb8611c6718a26e8865f5c9c17b4eb7c06d767e42d406f34754c14dfe23f3d1661adb6b106488cc58ae7dfb4bf9494ca11f81d9d530923c981b880ea36854dcb2cf22502f1d039e86bbcdb0c80cff273ae15774e74b00df5f318317897b0ca4807770020daa6653056d2d7c076d15f971cd5c74fff3f52707021f1aa47e500c21b447de6d03b7a94f433006f5bf0542f6fb889659f4b99abdb6f031ccb23761b12e1bd8c2de3a8ae72558012cadda96e7b0f6a7ebe681cfc1d5671e7c9beaa86d074e2d97c80ac083ee3281f814ff0ac3a3aec04c462f60521681536fa71a4f178a72b4480e566ffec7423ffea6125f34f5ccc33497bed536b12716f7b7803594d5f5db82f86e826e4f2c2597dc8eac958de95b45e3c4a189034aa00c0fa8373e7837bc4c0525cfc8dca7f93e6ca4835275b439f57d72ff1fd157f1af8b0977199b2a1b4364f07c78517dfc73973124881ce85f3db84282c1147f5d8e1f926c9d9102e74995393987eff51d594df2106c2fe7cbbc17efeb0bcb6c1542e7019aba8b7c72201095786e68119f4946d12d938096ec457ffc67235d54e7021cea0ece57b4fd2298b49687c7c2381df6de5d409320d428ee2a54b498abcf02a2a2d5233d05c0180184585a4095a3be4cdc856acfa0b3045abefdeb388b60af04a98977e33a401c93b6f95fece67fe3373cad85ed83a0b43dfbc8d34daab4f869c57c03fdb17e0e2f409d11c81b271ef773dbae513e6ee7f4500133f924830b66457fe67e84fb8fa12385bc2e2e960f290ad39da4f01a65e14de5bdac4345fac0f13d4a7f519f5d8059a9e09514d5d438672b489d0839695f7044e8fb85092dfb6572f990c205419d2190d6515b8b9707c2de28c023cbc6e52245cef04544e8959adafbd3e758a38e3a43c042d68b1eec9e7363b0649fa251ca82162252ba78859e2900d4ee017bbfaf28cded7d2993213e16ef44ad6d0bd7ae0e4c55fced8d35d904c4f9eefa996d396fcba85b78f4cc6017684e28dc86b4a4bf42ce4bb9eec3fdff7dd547fe1dc0ec5cc0bb0ade4a6a51c5325fa473392d6c598b3c518f205fbf9b261c25f16620fe6a1137866390460a89997d200c136352b496379318f108d971d1fb4501210033d8ff843a1010faf178a489dd436d01e3907978ceb4bbcf409277612250937afaf37b052c33c72ab1ff46a107fc1dc521b8d00616cd2543d6e180340cb7378ac0dad9c9bdc3bf31c1c4306d0171891b562da294cb009726f823f1e3598dbdeb4399c7c1b7e95571dcb037069f74912c22b058136fdb44e684e137b4ff21a5a45b4a56fab104f69984784e9c3d04eb11a230468038f134882f83569b623d0b36e0f82904accf7226897d51e25b7aeeb525776fae505c42e69976d323c3bdfca607564fcdc979ec2caec183ab2c5e1a054b8874a02cff357629ace6da0936a54045319c621a33f5ae3f39089fe1c90bfd4989048c090b84c7eaac8d1edf2098f4db5efcc01f8640e7b5906fc1d02acafadf36d17eda9f5a9644b23b09506745e6a29f0e2cf8b79e1a1abaa18c3dfea59a4aafec966b9bf9c960d4255775ef49bcfcf249a81520d7f20f271de0740998c690b52907fab873ffd40d9315f1dcd902ca1b527c097cbd7c22796d56cd5af04882339f88d23a8fcd5752b0c31bf3e05b5ecb8514b61b74de4070482ab0a824d67bf674b7d3db6e77e8f1700f316d55136a6a97f001e388c15a07191f15a0beb0f5754c56026b946ec14ae61f2a8801fe7ef9d606a1a3419673c09f4a58b188df5758348c7b5108ab702853a0e26b7950665b9e5be6ff3149eaf37bd8b1737853e2fa71b16cbea55eadc176122672b0c097900e4bf0c0179c97eba9091593fd81c64e99efcb9e0595d90ba47994ca13fe229e027b87c73cebd29bea0fde6b742e7e8ea4966d41bec0757d55fddc847b5da4cd23e5b513d21828910c10a36b42e7c4cab95853be9687bba6bef78e15224d6e50fcdb595bff30b1f8769b883b7b2848cd0bd5deddb6251ad3343963193fcc1affea4472c170086d984bc179fa0ef269c2ad7d8794702ecaab76eef06b0eed71abd1daf74e6e0445d761477592f78990c3eb26cdba4561e3bcbf178ea8d32e0a05818b850b02239ea4bf826760c50c883b6a0658a404e67d78d47f254d8fbcf10732f7b38ad680d8f47359500412699022be497eb8d8f647335c60bbff6dfe075e781b3e09cdc32083015d9934ee4c6c732cd9d213d9125a98d5055ba20400deb332267fac8a0594caf2821bceb93d631d0c4d9516cddade0c16e5e3b42b35d78787e07e4b6918cce7fd4f226f81eee3af56101dfe0c6ce4c33f31a61008d52faf7627ffe9f51f55f0f0d5cd399bf78a83a396612e55901aa8bfcdf7502763ae48199a55df27062364c81a68fa1eb5fa9661c151cdab0330a03e6794a7b30389a2627317a6f14324df0b07ec3e0fee05c2d4f43971a9fdbc88649d3fe78e1188d5500f88655cf79e63286914f08a23de45c4c9fdafa3ecef9014527ea20990bfab5566ad3f5f80bd52f0be0fb4abea26758b44bc1570812b504db3246f415de7500cd993feee13e8f51bf9b27439dff7e01552873554ba1bb08929d9b439ab9bc5b47b0851ce021be26e10e17f563f11b7bbb8b286cd3e476f6b517934b3b73b063cad93f13d4b75a2643c7e43fef92d26634b4bf403763c1dcb87b17cf4281bdecdf94e383102ebf733ff7f3372c1229c69f366546d042ed3612963aea7a3f3fd98fb676ed9046ab4ecaad9a4710babf8f0d8b734576986ca37acdd32fc5a6e6a008ebd90adfc8ef0d8cd16484afc48af9801123e19aa5b9176cb817509c82071d5235717c1884e6c26bfd5d8d19262315a42e5f13907f548b35d1869b3b8ac93e3dcaeea30ad9b7053057a12493e73d3a5a1626f8104f886c90418ddca8fa9a7b6fa8ead3cf461228685623dbb6750fcc6a64abd51ad080c3a3ccc151c0666a102487729a75e992dbf9e025410276d3bf51b7b2fcc2e3f891fbc29f47cca5078b71ee9cf4ead59b1add842346cb634e92cef98d2c6024822a1df5cb454f4a68904c72d97da83c4c4a8390f9c3df125cab96d047773cb21d93c79fb9c1b2c6d067be3cd731c5149043656c62f2c9b4179d67615dc10ba643a59d8437fba2948bd0a1a9e37b01e2b1d57a8ca16b7dbc599da704b5ecd7775249a6ef6fb82d6b7910901ccbb0962bbba3bdfdd50042ff44a04277e09646fd947bd1c3eb897bdacb4213404160d00904d2487b774cb7249f444a41e316b4b0af911edfe040239f440de100f915a8466dfa71e644770c5183a9f4381e343e456cada2598dc77c31dcfcaf9b3850b43179dbd5e39aba9fce8652a8d70a1bb147b9f87ed2ebd96b3e3075e446d87decd52711ec1d38ecd260c8144165f74c4bfdb17fc765e26ad8a85d71c06d4fd53823aec38346c7f1950f1ece29fc189585fe10299b09a47d28c81bf65dd71d11b6c48f499a724d324b2abddbc1dcbe18ebb0ffd7432b5ebf8ea34bb5845583062ab0129ee641de597a4e33151c69f4ce4fe8094d10906ed672104b4a42c4ae09986ce8a62ffd7d190f3ef8e672abd3f87d65651e4f617716e6697e4d0623ea48c054703538068226146faa71258770ad078ada578ba1b580ddf3a887ef7998a978ab71c370d3e161cdaf17101d23f63141e8ec5cb695fb63435174de72d368c7d2c80ab22609567b9baa546749dd3cdc853283ad5b19695cefef9e680ec7f0fec8046b32734d3b7f9615ccc378b38363b50b62ac932300ded728f0cea8b02f4bd02c883291441f79f7d62305504342c9f4344b3c7089de3cf295bdf209fd01525ac70d93fd4feaea40c26bde9c6b15f89b001519dc189bf84a871aff45b390a3aa3fa4872b387674afcaaa6d817d151131c1cf2adb2875859ffc612bf2d56b20958ecf5db232c2194b2966719089948bd0a4b6cf84c90ea9bdd2c9c024787f888b436686c7e4df722364d5c7000be26d56c3746a6d2b9a9594cb34ce57021a29f0000";
      contract_hash = "e803ba4ff3b8ad4e85d2415f93937ef90d20f5c55bebd641c02a045ba604f8a4";
      stringToEncrypt = "It is notable that the response to each public tragedy or threat in modern America seems to involve a call for citizens to surrender more of their rights.";
      newTx = createIssueAssetTx(unblindedPrevTx, contract_hash, theirAddress.unconfidentialAddress, mineAddress.unconfidentialAddress);

      // console.log(newTx);

      // sign the tx
      /*  we need to pass:
      **  - the unsigned transaction
      **  - the address from the previous tx we're spending, so that we know which privkey we're looking for
      **  - the derivation path, which is not necessarily the exact path, we'll look up to 100 pubkeys from the given path
      **  - the encrypted wallet and password to retrieve the master private key 
      **/
      // let address = "ert1qnzarlexyngnepn8jsksl899yefsv4c6evzkjen4fevjgww46rtusln52pj"; // P2WSH address to be sure that it fails
      let address = "ert1qqle9330xg8vd7t3zj6h6h7khffulxcx2w84l3s";
      // let address = "ert1qmz4vuj0y7vc36rm630d9yfx27ppkg06smtljyq";
      signedTx = signIssueAssetTx(newTx, address, restored);

      // console.log(signedTx);

      // sign an arbitrary hash with a key derived from our xprv
      signature = signHash(restored.xprv, "0/0", 0, stringToEncrypt);

      console.log(signature);

      signatureOK = verifySignature(JSON.parse(signature).address, stringToEncrypt, JSON.parse(signature).signature);
      console.log(signatureOK);

      let numberToEncrypt = 3;
      let Wallets = [];
      for (i = 0; i < numberToEncrypt; i++) {
        var temp = JSON.parse(newWallet());
        
        var wallet = {
          "xprv": temp.xprv,
          "xpub": temp.xpub,
          "hdPath": "100/1000", 
        }

        Wallets.push(wallet);
      }

      let Ciphers = [];
      for (i = 0; i < numberToEncrypt; i++) {
        cipher = JSON.parse(encryptMessageWithXpub(stringToEncrypt, Wallets[i].xprv, Wallets[i].hdPath, 100));

        Ciphers.push(cipher);
      }

      console.log("Ciphers is " + JSON.stringify(Ciphers));

      // try to decrypt the messages
      for (i = 0; i < Ciphers.length; i++) {
        temp = Ciphers[i];

        var path = temp.hdPath;
        var range = temp.range;
        var encryptedMessage = temp.encryptedMessage;
        var pubkey = temp.pubkey;
        var senderPubkey = temp.senderPubkey;
        var xprv = Wallets[i].xprv;

        var clearMessage = decryptMessage(encryptedMessage, xprv, path, range, pubkey, senderPubkey);
        console.log("clear message is " + clearMessage);
      }

      // cleanup when we're over
      cleanUp();
      console.log("Cleanup and terminating");
    }
    var Module = {
      onRuntimeInitialized: function () {
        main();
      }
    };
  </script>
</body>

</html>

